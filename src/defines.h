/*
 * defines.h
 *
 *  Created on: 1 Feb. 2018 Ð³.
 *      Author: Voldemar Khramtsov <harestomper@gmail.com>
 *
 */

#ifndef SRC_DEFINES_H_
#define SRC_DEFINES_H_
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#ifndef null
#define null ((void*) 0)
#endif
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define BUFFER_SIZE 1024
#define STRSIZE 256
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define ckfree(x)                                                              \
  __extension__({                                                              \
    if (x)                                                                     \
      free (x);                                                                \
    (x) = null;                                                                \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define set_fd(dest, src)                                                      \
  __extension__({                                                              \
    if ((dest) >= 0)                                                           \
      close (dest);                                                            \
    (dest) = (src);                                                            \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define MAX(a, b)                                                              \
  __extension__({                                                              \
    __typeof__(a) __a = (a);                                                   \
    __typeof__(b) __b = (b);                                                   \
    __a > __b ? __a : __b;                                                     \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define MIN(a, b)                                                              \
  __extension__({                                                              \
    __typeof__(a) __a = (a);                                                   \
    __typeof__(b) __b = (b);                                                   \
    __a < __b ? __a : __b;                                                     \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define SETSTR(to, from)                                                       \
  __extension__({                                                              \
    bool_t __r = false;                                                        \
    if ((from) && *(from))                                                     \
      {                                                                        \
        ckfree (to);                                                           \
        to = strdup (from);                                                    \
        __r = (to != null);                                                    \
      }                                                                        \
    __r;                                                                       \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define FIELD(fn, tp) FIELD_##fn,
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define MKTYPES(fn, tp) TYPE_##tp,
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define MAKE(FN)                                                               \
  FN (NONE, NONE)                                                              \
  FN (WORKDIR, STRING)                                                         \
  FN (SOCKNAME, STRING)                                                        \
  FN (PIDFILE, STRING)                                                         \
  FN (CONFIG, STRING)                                                          \
  FN (DAEMON, NONE)                                                            \
  FN (START, NONE)                                                             \
  FN (INC, NONE)                                                               \
  FN (DEC, NONE)                                                               \
  FN (ON, NONE)                                                                \
  FN (OFF, NONE)                                                               \
  FN (SWITCH, NONE)                                                            \
  FN (STOP, NONE)                                                              \
  FN (RESTART, NONE)                                                           \
  FN (MINIMAL, INT)                                                            \
  FN (NUM_LEVELS, INT)                                                         \
  FN (TRANSITION, INT)                                                         \
  FN (SAVED, NONE)                                                             \
  FN (DEVNAME, STRING)                                                         \
  FN (LIST, NONE)                                                              \
  FN (STUB, NONE)
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define _seterrf(e, fmt, ...)                                                  \
  __extension__({                                                              \
    int __n = snprintf ((e), sizeof (e), "ERROR: ");                           \
    snprintf ((e) + __n, sizeof (e) - __n, fmt, __VA_ARGS__);                  \
  })
#define seterrf(e, fmt, ...)                                                   \
  __extension__({                                                              \
    int __n = snprintf ((e), sizeof (e), "ERROR:%s:%i: ", __func__, __LINE__); \
    snprintf ((e) + __n, sizeof (e) - __n, fmt, __VA_ARGS__);                  \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
#define eprintf(fmt, ...)                                                      \
  __extension__({                                                              \
    char __eprt_tmp[STRSIZE];                                                  \
    seterrf (__eprt_tmp, fmt, __VA_ARGS__);                                    \
    fprintf (stderr, "%s\n", __eprt_tmp);                                      \
  })
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

#endif    // SRC_DEFINES_H_
